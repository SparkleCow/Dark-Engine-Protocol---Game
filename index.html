<!DOCTYPE html>
<html>
<head>
    <title>Dark Orbit Clone Client</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            overflow: hidden; /* Evita barras de desplazamiento */
            margin: 0;
            font-family: Arial, sans-serif;
        }
        /* Estilo básico para tu nave (el objeto que vas a mover) */
        .player-ship {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #00ff00; /* Verde neón */
            border-radius: 50%;
            transition: transform 0.1s linear; /* Movimiento más suave */
        }
        /* Estilo para las naves de otros jugadores */
        .other-ship {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ff0000; /* Rojo */
            border-radius: 50%;
            pointer-events: none; /* No interactúan con el ratón */
        }
        #status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff00;
        }
    </style>
</head>
<body>

    <div id="status">Status: Connecting...</div>
    <div id="game-area">
        </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script>
        // --- Configuración de Red ---
        const SOCKET_URL = 'http://localhost:8080/ws'; // Tu endpoint STOMP
        let stompClient = null;

        const RANDOM_SUFFIX = Math.floor(Math.random() * 100000);
        const PLAYER_ID = Date.now() + RANDOM_SUFFIX; // Esto resulta en un número grande, ej: 173255952012345

        const SHIP_ELEMENT_ID = 'player-' + PLAYER_ID;
        
        // Estado del jugador (lo que el cliente quiere enviar)
        let playerState = {
            playerId: PLAYER_ID,
            x: 500, // Posición inicial X
            y: 300, // Posición inicial Y
            angle: 0,
            mapId: 1
        };

        // Almacén de las naves de otros jugadores
        const otherShips = new Map();

        // --- Inicialización del DOM ---
        const gameArea = document.getElementById('game-area');
        
        // Crea el elemento visual de la nave local
        const playerShip = document.createElement('div');
        playerShip.id = SHIP_ELEMENT_ID;
        playerShip.classList.add('player-ship');
        gameArea.appendChild(playerShip);

        // --- Lógica de Conexión ---
        function connect() {
            const socket = new SockJS(SOCKET_URL);
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, frame => {
                document.getElementById('status').innerText = 'Status: Connected';
                console.log('Connected: ' + frame);

                // 1. Suscripción al Topic de Sincronización Global
                // Recibe la lista de todas las posiciones cada 100ms
                stompClient.subscribe('/topic/sync/all-positions', message => {
                    const positions = JSON.parse(message.body);
                    handleGlobalSync(positions);
                });

                // 2. Suscripción al Topic de Movimiento Individual (Opcional, si lo usas)
                // stompClient.subscribe('/topic/updates/movement', message => { /* ... */ });
                
                // Mueve la nave a la posición inicial
                updateLocalShipVisuals(playerState.x, playerState.y, playerState.angle);

            }, error => {
                document.getElementById('status').innerText = 'Status: Disconnected. Retrying...';
                console.error('STOMP error:', error);
                setTimeout(connect, 5000); // Intenta reconectar
            });
        }

        // --- Lógica de Recepción de Datos (Sincronización) ---
        function handleGlobalSync(positions) {
            
            // Crea un set con los IDs recibidos para saber quién sigue activo
            const activeIds = new Set();
            
            positions.forEach(pos => {
                activeIds.add(pos.playerId);
                
                if (pos.playerId === PLAYER_ID) {
                    // Ignora tu propia nave si el servidor la devuelve
                    return; 
                }

                // 1. Obtener/Crear el elemento visual de la nave remota
                let ship = otherShips.get(pos.playerId);
                if (!ship) {
                    // Es un jugador nuevo, crea el elemento
                    ship = document.createElement('div');
                    ship.id = 'player-' + pos.playerId;
                    ship.classList.add('other-ship');
                    gameArea.appendChild(ship);
                    otherShips.set(pos.playerId, ship);
                }
                
                // 2. Aplicar la posición recibida
                // Esto simula el movimiento de otro jugador
                updateRemoteShipVisuals(ship, pos.x, pos.y, pos.angle);
            });
            
            // 3. Limpieza: Eliminar naves de jugadores desconectados
            // Itera sobre el mapa de naves y elimina las que no estaban en la lista de activos.
            otherShips.forEach((ship, id) => {
                if (!activeIds.has(id)) {
                    ship.remove();
                    otherShips.delete(id);
                }
            });
        }

        function updateRemoteShipVisuals(shipElement, x, y, angle) {
            shipElement.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg)`;
        }

        // --- Lógica de Envío de Datos (Movimiento Local) ---

        // Tecla presionada (para simular movimiento básico)
        const keysPressed = {};
        window.addEventListener('keydown', (e) => { keysPressed[e.code] = true; });
        window.addEventListener('keyup', (e) => { keysPressed[e.code] = false; });

        // Constantes de movimiento
        const SPEED = 5; // Pixeles por tick
        const SEND_INTERVAL = 50; // Enviar la posición al servidor cada 50ms (20 FPS)
        let lastSendTime = 0;
        
        function gameLoop(timestamp) {
            let moved = false;
            
            // 1. Actualización de posición local
            if (keysPressed['ArrowUp'] || keysPressed['KeyW']) {
                playerState.y -= SPEED;
                moved = true;
            }
            if (keysPressed['ArrowDown'] || keysPressed['KeyS']) {
                playerState.y += SPEED;
                moved = true;
            }
            if (keysPressed['ArrowLeft'] || keysPressed['KeyA']) {
                playerState.x -= SPEED;
                moved = true;
            }
            if (keysPressed['ArrowRight'] || keysPressed['KeyD']) {
                playerState.x += SPEED;
                moved = true;
            }

            // 2. Actualizar el visual local
            if (moved) {
                updateLocalShipVisuals(playerState.x, playerState.y, playerState.angle);
            }

            // 3. Enviar posición al Servidor (si es hora)
            if (stompClient && stompClient.connected && timestamp - lastSendTime > SEND_INTERVAL) {
                // Enviar el objeto Position a /app/move
                stompClient.send("/app/move", {}, JSON.stringify(playerState));
                lastSendTime = timestamp;
            }

            // 4. Continuar el bucle
            window.requestAnimationFrame(gameLoop);
        }

        function updateLocalShipVisuals(x, y, angle) {
            // Usa transform para un mejor rendimiento que cambiar top/left directamente
            playerShip.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg)`;
        }

        // --- Inicio ---
        connect();
        window.requestAnimationFrame(gameLoop); // Inicia el bucle de juego
    </script>

</body>
</html>